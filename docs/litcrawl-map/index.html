<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Litcrawl map</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
	<style>
	body {
		margin: 0;
		padding: 0;
	}
	
	#map {
		position: absolute;
		top: 0;
		bottom: 0;
		width: 100%;
	}

	/* pop-up styling */

    .mapboxgl-popup-content h4 {
		font-weight: 300;
		font-size: 1.5em;
		border-width: 0px 0px 0.5px 0px;
		border-style: solid;
		border-color: rgb(80, 80, 80);
		margin-top: 0.5em;
		margin-bottom: 0.5em;
	}

    .mapboxgl-popup-content h5 {
		font-weight: 300;
		font-size: 1.2em;
		border-width: 0px 0px 0.5px 0px;
		border-style: solid;
		border-color: rgb(80, 80, 80);
		margin-top: 0.5em;
		margin-bottom: 0.5em;
	}

	.mapboxgl-popup-content h2 {
		font-weight: 500;
		margin-top: 0.5em;
		margin-bottom: 0.3em;
	}
	.mapboxgl-popup-content p {
		font-weight: 300;
		margin-top: 0.3em;
		margin-bottom: 0em;
	}

	/* overlay styling */

	/* legend stuff */

	.map-overlay {
		position: absolute;
		bottom: 0;
		right: 0;
		background: #fff;
		margin-right: 20px;
		font-family: Calibri;
		overflow: auto;
		border-radius: 3px;
	}

	#legend {
		padding: 10px;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
		line-height: 18px;
		height: 55px;
		margin-bottom: 40px;
		width: 120px;
	}

	.legend-key {
		display: inline-block;
		border-radius: 20%;
		width: 10px;
		height: 10px;
		margin-right: 5px;
  	}


	</style>
</head>

<body>
	<style>
	.mapboxgl-popup {
		max-width: 400px;
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
	}
	</style>
		<div id="map"></div>
		<div class='map-overlay' id='legend'></div>
	<script>

	mapboxgl.accessToken = 'pk.eyJ1IjoibWxub3ciLCJhIjoiY2t0d2FsdWRpMmkxbDMxcnJ4eTNsMmFlMiJ9.dUju5BD_HqseLNWGIGvXpg';

	// define layer names
	const legendLayers = [
		'5–6pm',
		'6:30–7:30pm',
		'8–9pm'
	];
	const legendColors = [
		'#2ECC71',
		'#3498DB',
		'#9B59B6'
	];

	const map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mlnow/ckupqbcwzedlb18qxbjyv9o8g',
		zoom: 15,
		center: [-122.421, 37.7585],
        pitch: 50 // pitch in degrees
	});

	map.on('load', () => {
		map.addSource('places', {
			'type': 'geojson',
			'data': 'litcrawlMap.geojson'
		});

		// Add a layer showing the places.
		map.addLayer({
			'id': 'places',
			'type': 'circle',
			'source': 'places',
			'paint': {
				'circle-color': [
                    'match',
                    ['get', 'time'],
                    '5pm–6pm',
                    '#2ECC71',
                    '6:30pm–7:30pm',
                    '#3498DB',
                    '8pm–9pm',
                    '#9B59B6',
                    /* other */ '#FFFFFF'
                    ],
				'circle-radius': {
                      'base': 5,
                      'stops': [
                          [12, 10],
                          [22, 100]
                      ]
                  },
				'circle-stroke-width': 0,
				'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.75
			}
		});
		// Create a popup, but don't add it to the map yet.
		const popup = new mapboxgl.Popup({
			closeButton: true,
			closeOnClick: true
		});
        map.on('mouseenter', 'places', (e) => {
			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = 'pointer';
		});

		map.on('click', 'places', (e) => {
			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = 'pointer';
			// Copy coordinates array.
			const coordinates = e.features[0].geometry.coordinates.slice();
            const title = e.features[0].properties.title;
            const time = e.features[0].properties.time;
			const description = e.features[0].properties.description_short;
            const address = e.features[0].properties.address;
            const link = e.features[0].properties.link;
            const register_link = e.features[0].properties.register_link;
            const labelMap = '<h4>'+time+'</h4>'
                      + '<h5>'+title+'</h5>'
                      + '<p><strong>What?</strong> '+description+'</p>'
                      + '<p><strong>Where?</strong> '+address+'</p>'
                      + '<p><strong>More details:</strong> <a target="_blank" href="'+link+'"> click here</a></p>'
                      + '<p><strong>Register:</strong> <a target="_blank" href="'+register_link+'"> click here</a></p>';
			// Ensure that if the map is zoomed out such that multiple
			// copies of the feature are visible, the popup appears
			// over the copy being pointed to.
			while(Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
			}
			// Populate the popup and set its coordinates
			// based on the feature found.
			popup.setLngLat(coordinates).setHTML(labelMap).addTo(map);
		});
		map.on('mouseleave', 'places', () => {
			map.getCanvas().style.cursor = '';
		});

		  // create legend
		  const legend = document.getElementById('legend');

		  	legendLayers.forEach((layer, i) => {
			const color = legendColors[i];
			const item = document.createElement('div');
			const key = document.createElement('span');
			key.className = 'legend-key';
			key.style.backgroundColor = color;
			
			const value = document.createElement('span');
			value.innerHTML = `${layer}`;
			item.appendChild(key);
			item.appendChild(value);
			legend.appendChild(item);
			});

	});
	</script>
</body>

</html>